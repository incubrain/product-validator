#!/usr/bin/env sh
# .husky/pre-push

echo ""
echo "üîç Checking for production leads to backup..."
echo ""

pnpm leads:backup

# Check exit code
if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå Backup failed."
  echo ""
  echo "‚ö†Ô∏è  This usually means:"
  echo "   - Production server is down"
  echo "   - PRODUCTION_URL or PRODUCTION_STORAGE_SECRET is incorrect"
  echo "   - Network issues"
  echo ""
  
  # Admin override prompt - redirect stdin from terminal
  exec < /dev/tty
  printf "Continue push anyway? (ADMIN OVERRIDE - y/n): "
  read -r REPLY
  echo ""
  
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "‚ùå Push cancelled"
    exit 1
  fi
  
  echo "‚ö†Ô∏è  WARNING: Pushing without backup!"
  echo ""
else
  echo ""
  echo "‚ö†Ô∏è  Next steps after deployment:"
  echo "   1. Wait for deployment to complete"
  echo "   2. Run: pnpm leads:restore"
  echo ""

  # Normal confirmation prompt - redirect stdin from terminal
  exec < /dev/tty
  printf "Continue with push? (y/n): "
  read -r REPLY
  echo ""

  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "‚ùå Push cancelled"
    exit 1
  fi
fi

echo "‚úÖ Proceeding with push..."
echo ""